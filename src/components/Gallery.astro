---
import { queryTags } from "../utils/contentful/api"
import { throwError } from "../utils/helpers"

type Props = {
	tag: string
}

const { tag } = Astro.props

const tags = await queryTags(`metadata.tags.sys.id[all]=${tag}`)

const remoteImages = tags.items.map((item, index) => {
	const asset = tags.includes.Asset[index] ?? throwError("Error finding corresponding asset object")
	return {
		alt: item.fields.alt,
		src: asset.fields.file.url,
	}
})

type Image = {
	src: string
	alt: string
}

function splitImageArray(array: Image[], subArrayCount: number) {
	const subArrays: Image[][] = Array.from({ length: subArrayCount }, () => [])

	for (let i = 0; i < array.length; i++) {
		const subArrayIndex = i % subArrayCount
		subArrays[subArrayIndex]!.push(array[i]!)
	}

	return subArrays
}

const imageArrays = splitImageArray(remoteImages, 4)
---

<div id="container" class="grid grid-cols-1 sm:grid-cols-4 p-5 sm:p-12 gap-4 z-50">
	<div>
		{
			imageArrays[0]?.map((image) => (
				<img class="h-auto max-w-full pb-4" src={image.src} alt={image.alt} loading="lazy" />
			))
		}
	</div>
	<div>
		{
			imageArrays[1]?.map((image) => (
				<img class="h-auto max-w-full pb-4" src={image.src} alt={image.alt} loading="lazy" />
			))
		}
	</div>
	<div>
		{
			imageArrays[2]?.map((image) => (
				<img class="h-auto max-w-full pb-4" src={image.src} alt={image.alt} loading="lazy" />
			))
		}
	</div>
	<div>
		{
			imageArrays[3]?.map((image) => (
				<img class="h-auto max-w-full pb-4" src={image.src} alt={image.alt} loading="lazy" />
			))
		}
	</div>
</div>
